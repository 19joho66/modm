// coding: utf-8
/* Copyright (c) 2015, Roboterclub Aachen e.V.
 * All Rights Reserved.
 *
 * The file is part of the xpcc library and is released under the 3-clause BSD
 * license. See the file `LICENSE` for the full license governing this code.
 */
// ----------------------------------------------------------------------------

#include "../../../device.hpp"
#include "../../clock/generic/common_clock.hpp"

extern "C"
{

%% if target is stm32f1
	%% set overhead = 20
%% else
	%% set overhead = 35
%% endif

void ATTRIBUTE_FASTCODE
_delay_us(uint16_t us)
{
	if (!us) return;

	uint32_t start = DWT->CYCCNT;
	// prefer this for cores with fast hardware multiplication
	int32_t delay = int32_t(xpcc::clock::fcpu_MHz) * us - {{ overhead }};

	while (int32_t(DWT->CYCCNT - start) < delay)
		;
}

void ATTRIBUTE_FASTCODE
_delay_ms(uint16_t ms)
{
	if (!ms) return;

	uint32_t start = DWT->CYCCNT;
	int32_t delay = int32_t(xpcc::clock::fcpu_kHz) * ms - {{ overhead }};

	while (int32_t(DWT->CYCCNT - start) < delay)
		;
}

}
