# Copyright (c) 2018, Sergiy Yevtushenko
# Copyright (c) 2018-2020, Niklas Hauser
#
# This file is part of the modm project.
#
# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.

# This file was autogenerated by the modm cmake builder. Do not modify!

option(BUILD_TESTS "Build test programs" OFF)

cmake_minimum_required(VERSION 3.6)

%% for path in generated_paths
include(./{{ path }}/repo.cmake)
%% endfor

project({{ project_name }})

file(GLOB APP_SOURCE_FILES *.c *.cpp */*.c */*cpp)
list(APPEND SOURCE_FILES ${APP_SOURCE_FILES})
include_directories(${CMAKE_CURRENT_SOURCE_DIR})

#add_executable(${CMAKE_PROJECT_NAME} ${SOURCE_FILES})

if (NOT BUILD_TESTS)

add_executable(${CMAKE_PROJECT_NAME} ${SOURCE_FILES})
    add_subdirectory(src)
else()
    enable_testing()
    add_subdirectory(test)
endif()


if (NOT BUILD_TESTS)
set_target_properties(${CMAKE_PROJECT_NAME} PROPERTIES SUFFIX ".elf")

%% if platform != "hosted"
add_custom_target(${CMAKE_PROJECT_NAME}.bin ALL DEPENDS ${CMAKE_PROJECT_NAME} COMMAND ${CMAKE_OBJCOPY} -Obinary ${CMAKE_PROJECT_NAME}.elf ${CMAKE_PROJECT_NAME}.bin)
add_custom_target(${CMAKE_PROJECT_NAME}.hex ALL DEPENDS ${CMAKE_PROJECT_NAME} COMMAND ${CMAKE_OBJCOPY} -Oihex ${CMAKE_PROJECT_NAME}.elf ${CMAKE_PROJECT_NAME}.hex)
add_custom_target(${CMAKE_PROJECT_NAME}.lss ALL DEPENDS ${CMAKE_PROJECT_NAME} COMMAND ${CMAKE_OBJDUMP}  -x -s -S -l -w ${CMAKE_PROJECT_NAME}.elf > ${CMAKE_PROJECT_NAME}.lss)
%% endif

%% if core.startswith("avr")
add_custom_command(TARGET ${CMAKE_PROJECT_NAME} POST_BUILD COMMAND ${CMAKE_SIZE} ARGS -C -d --mcu={{ partname }} ${CMAKE_PROJECT_NAME}.elf)
%% elif core.startswith("cortex-m")
#% FIXME: build path does not contain python tools of course
#% add_custom_command(TARGET ${CMAKE_PROJECT_NAME} POST_BUILD VERBATIM COMMAND python3 ./modm/modm_tools/size.py ${CMAKE_PROJECT_NAME}.elf "{{memories}}")
%% endif
endif()